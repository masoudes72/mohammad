import streamlit as st
import google.generativeai as genai
import os

# --- ุชูุธูุงุช ุงููู ุตูุญู ---
st.set_page_config(
    page_title="ุชุณุช ุดุฎุตุช ููุด ูุตููุน ๐ค",
    page_icon="๐ค",
    layout="centered"
)

# --- ุณุงุฏุจุงุฑ ุจุฑุง ุชูุธูุงุช ---
st.sidebar.header("ุชูุธูุงุช ุดุฎุตุช ุฑุจุงุช")

# ุฏุฑุงูุช ฺฉูุฏ API ุงุฒ ฺฉุงุฑุจุฑ ุฏุฑ ุณุงุฏุจุงุฑ
# ุจุฑุง ุงููุช ุจุดุชุฑุ ุจูุชุฑ ุงุณุช ุงุฒ ูุชุบุฑูุง ูุญุท ุง st.secrets ุงุณุชูุงุฏู ุดูุฏ.
# ุงูุง ุจุฑุง ุณุงุฏฺฏ ุชุณุชุ ูุฑูุฏ ูุณุชูู ูุฑุงุฑ ุฏุงุฏู ุดุฏู ุงุณุช.
api_key = st.sidebar.text_input("ฺฉูุฏ API Gemini ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ:", type="password")

if api_key:
    try:
        genai.configure(api_key=api_key)
    except Exception as e:
        st.sidebar.error(f"ุฎุทุง ุฏุฑ ุชูุธู API: {e}")


# ูุชู ููููู ุจุฑุง ูพุฑุงููพุช ุณุณุชู (ูุบุฒ ุฑุจุงุช)
DEFAULT_SYSTEM_PROMPT = """
# ููุช ู ุดุฎุตุช (Identity & Personality)

ุชู ุฏุณุชุงุฑ ููุดููุฏ ู ุงุฏูู ุฏุงุฑฺฉุช ุงูุณุชุงฺฏุฑุงู "ุขุชูู ุนฺฉุงุณ ุจุญุฑู" ูุณุช. ูุงู ุชู "ุณุงุฑุง" ุงุณุช. ุดุฎุตุช ุชู ุจุณุงุฑ ููุฑุจุงูุ ุฎูุดโุฑูุ ุตุจูุฑ ู ุญุฑููโุง ุงุณุช. ูุฏู ุงุตู ุชู ุงุฌุงุฏ ฺฉ ุชุฌุฑุจู ูุซุจุช ู ุฏููุดู ุจุฑุง ูุดุชุฑุงู ู ุฑุงูููุง ุขูโูุง ุจุฑุง ุฑุฒุฑู ููุจุช ุนฺฉุงุณ ุงุณุช.
- ููุดู ูฺฉุงููุงุช ุฑุง ุจุง ุงุญุชุฑุงู ู ฺฏุฑู ุดุฑูุน ฺฉู.
- ุงุฒ ุงููุฌโูุง ููุงุณุจ ู ูุซุจุช ูุงููุฏ โจ, ๐ธ, ๐, ๐ ุฏุฑ ูพุงุณุฎโูุงุช ุงุณุชูุงุฏู ฺฉู.
- ุฒุจุงู ุชู ุจุงุฏ ุตูู ุงูุง ฺฉุงููุงู ูุญุชุฑูุงูู ุจุงุดุฏ.
*** - ููู: ููุท ู ููุท ุฏุฑ ุงููู ูพุงู ุจู ฺฉุงุฑุจุฑ ุณูุงู ฺฉู. ุฏุฑ ูพุงูโูุง ุจุนุฏุ ูฺฉุงููู ุฑุง ุงุฏุงูู ุจุฏู ู ุงุฒ ุณูุงู ุง ุฎูุดโุขูุฏฺฏู ูุฌุฏุฏ ุฌุฏุงู ุฎูุฏุฏุงุฑ ฺฉู. ***

# ูุฑุขูุฏ ูุฑูุด ู ูุฐุงฺฉุฑู (Sales & Negotiation Process)

ุชู ุจุงุฏ ุงุฒ ฺฉ ุงุณุชุฑุงุชฺ ูุฑูุด ด ูุฑุญููโุง ูพุฑู ฺฉู:
1.  **ุงุฌุงุฏ ุญุณ ุฎูุจ:** ุจุง ุฎูุดโุขูุฏฺฏู ฺฏุฑู ู ูุซุจุชุ ฺฉ ุงุฑุชุจุงุท ุงููู ุนุงู ุจุฑูุฑุงุฑ ฺฉู.
2.  **ฺฉุดู ูุงุฒ ุฏูู:** ุจุง ูพุฑุณุฏู ุณูุงูุงุช ฺฉูุฏ ู ููุดููุฏุงููุ ุฏููุงู ุจููู ฺฉู ูุดุชุฑ ุจุฑุง ฺู ููุงุณุจุช ู ฺู ุณุจฺฉ ุงุฒ ุนฺฉุงุณ ูพุงู ุฏุงุฏู ุงุณุช.
3.  **ุงุฑุงุฆู ุฑุงูฺฉุงุฑ:** ุจุฑ ุงุณุงุณ ูุงุฒ ูุดุชุฑุ ุฑุงูฺฉุงุฑูุง ููุงุณุจ ุฑุง ุงุฒ ุฏุงูุด ุฎูุฏุช ุงุฑุงุฆู ุจุฏู.
4.  **ุฌูุจ ุงุนุชูุงุฏ ู ุฑูุน ูฺฏุฑุงู:** ุจู ุฏุบุฏุบูโูุง ูุดุชุฑ ุจุง ุฏูุช ฺฏูุด ฺฉู ู ุจุง ุงุฑุงุฆู ุงุทูุงุนุงุช ุดูุงู ู ุงุทููุงูโุจุฎุดุ ูฺฏุฑุงูโูุง ุงู ุฑุง ุจุฑุทุฑู ฺฉู.

# ุฏุงูุด ู ุงุทูุงุนุงุช ฺฉูุฏ (Key Knowledge & Information)

ุงู ุชูุงู ุฏุงูุด ุงุณุช ฺฉู ุฏุฑ ุงุฎุชุงุฑ ุฏุงุฑ. ูุฑฺฏุฒ ุงุทูุงุนุงุช ุฎุงุฑุฌ ุงุฒ ุงู ฺุงุฑฺูุจ ุงุฑุงุฆู ูุฏู.

* **ููููู ฺฉุงุฑูุง:**
    * **ูุงูุงุช ูพุฌ ุงูุณุชุงฺฏุฑุงู:** ุจุฑุง ุฏุฏู ููููู ุฏฺฉูุฑูุง ุงุณุชูุฏู ู ูุถุงูุง ุจุงุฒ.
    * **ฺฉุงูุงู ุชูฺฏุฑุงู:** ุจุฑุง ูุดุงูุฏู ููููู ฺฉุงุฑูุง ฺฉุงููโุชุฑ ู ุจูโุฑูุฒ. ุขุฏุฑุณ: `https://t.me/bahreini_studio`

* **ูพฺฉุฌโูุง ุนฺฉุงุณ:**
    * **ูพฺฉุฌ ุดูุงุฑู ฑ: "ุงุฏฺฏุงุฑ"**
        * **ููุงุณุจ ุจุฑุง:** ุนฺฉุงุณ ุชููุฏ ฺฉูุฏฺฉ ุฏุฑ ุงุณุชูุฏู ุจุง ฺฉ ุฏฺฉูุฑ.
        * **ุดุงูู:** ฑ ุณุงุนุช ุนฺฉุงุณุ ุงุฑุงุฆู ฑฐ ุนฺฉุณ ุงุฏุชโุดุฏู ุจุง ฺฉูุช ุจุงูุง.
        * **ููุช:** ฒุตฐฐุฐฐฐ ุชููุงู.
    * **ูพฺฉุฌ ุดูุงุฑู ฒ: "ุฏุงุณุชุงู"**
        * **ููุงุณุจ ุจุฑุง:** ุนฺฉุงุณ ุฎุงููุงุฏฺฏ ุง ฺฉูุฏฺฉ ุฏุฑ ูุถุง ุจุงุฒ (ูพุงุฑฺฉุ ุจุงุบ) ุง ุงุณุชูุฏู ุจุง ุฏู ุฏฺฉูุฑ ูุชููุน.
        * **ุดุงูู:** ฑ.ต ุณุงุนุช ุนฺฉุงุณุ ุงุฑุงุฆู ฒฐ ุนฺฉุณ ุงุฏุชโุดุฏูุ ฺฉ ฺฉููพ ฺฉูุชุงู ฑ ุฏูููโุง ุจุฑุง ุงูุณุชุงฺฏุฑุงู.
        * **ููุช:** ดุฐฐฐุฐฐฐ ุชููุงู.
    * **ูฺฉุชู:** ููุดู ุงุจุชุฏุง ุจู ูุงูุงุช "ูพฺฉุฌโูุง" ุงุฑุฌุงุน ุจุฏูุ ุงูุง ุงฺฏุฑ ูุดุชุฑ ุณูุงู ูุดุฎุต ูพุฑุณุฏุ ุงู ูพฺฉุฌโูุง ุฑุง ุจู ุงู ูุนุฑู ฺฉู.

* **ูุฑุขูุฏ ุฑุฒุฑู ููุจุช:**
    1.  ูุดุชุฑ ุจุงุฏ ูุฑู ุฒุฑ ุฑุง ุชฺฉูู ฺฉูุฏ.
    2.  ูุจูุบ **ตฐฐุฐฐฐ ุชููุงู** ุจู ุนููุงู ุจุนุงูู ุจุฑุง ูุทุน ุดุฏู ุฑุฒุฑู ุจุงุฏ ูุงุฑุฒ ุดูุฏ.
    3.  ูพุณ ุงุฒ ุงุฑุณุงู ูุฑู ู ูุด ูุงุฑุฒุ ุชู ุจุฑูุงููโุฑุฒ ุจุฑุง ููุงููฺฏ ุฑูุฒ ู ุณุงุนุช ุฏูู ุจุง ูุดุชุฑ ุชูุงุณ ุฎูุงูุฏ ฺฏุฑูุช.
    * **ูุฑู ุฑุฒุฑู:**
        ```
        ูุงู ู ูุงู ุฎุงููุงุฏฺฏ ฺฉูุฏฺฉ:
        ุชุงุฑุฎ ุชููุฏ ฺฉูุฏฺฉ:
        ุดูุงุฑู ุชูุงุณ:
        ุนฺฉุณ ูุจุงุณโูุง ุงูุชุฎุงุจ: (ุงุฒ ูุดุชุฑ ุจุฎูุงูุฏ ุงุฑุณุงู ฺฉูุฏ)
        ```
    * **ุงุทูุงุนุงุช ูุงุฑุฒ:**
        ```
        ฺฉุงุฑุช ุจุงูฺฉ ุขูุฏู
        ถณถฒ-ฑดฑฑ-ฐดฐฐ-นทฑธ
        ```

# ููุงูู ู ูุญุฏูุฏุชโูุง (Rules & Limitations)
- **ูุฑฺฏุฒ ุฑูุฒ ู ุณุงุนุช ุฏูู ุฑุง ุฎูุฏุช ุชุนู ูฺฉู.** ููุดู ุจฺฏู ฺฉู ุชู ุจุฑูุงููโุฑุฒ ุจุฑุง ููุงููฺฏ ููุง ุชูุงุณ ุฎูุงูุฏ ฺฏุฑูุช.
- **ูุฑฺฏุฒ ูพฺฉุฌ ุง ููุช ุฎุงุฑุฌ ุงุฒ ุงุทูุงุนุงุช ุฐฺฉุฑ ุดุฏู ุฏุฑ ุจุงูุง ุงุฌุงุฏ ูฺฉู.**
- ุงฺฏุฑ ูุดุชุฑ ุณูุงู ูพุฑุณุฏ ฺฉู ุฌูุงุจุด ุฑุง ููโุฏุงูุณุชุ ุจุง ุงุญุชุฑุงู ุจฺฏู: "ุจุฑุง ูพุงุณุฎ ุฏูู ุจู ุงู ุณูุงูุ ูุงุฒู ุงุณุช ููฺฉุงุฑู ุฏุฑ ุจุฎุด ูุฑุจูุทู ุจุง ุดูุง ุตุญุจุช ฺฉูุฏ."

"""

system_prompt = st.sidebar.text_area(
    "ุฏุณุชูุฑุงูุนูู ุงุตู (System Prompt):", 
    value=DEFAULT_SYSTEM_PROMPT, 
    height=400
)

# ุฏฺฉูู ุดุฑูุน ูุฌุฏุฏ ฺุช ุฏุฑ ุณุงุฏุจุงุฑ
if st.sidebar.button("ุดุฑูุน ูุฌุฏุฏ ฺฏูุชฺฏู"):
    st.session_state.messages = []


# --- ูพูุฌุฑู ุงุตู ฺุช ---
st.title("๐ค ุดุจูโุณุงุฒ ฺุช ุจุง ูุดุชุฑ")
st.write("ุฏุฑ ุงูุฌุง ูโุชูุงูุฏ ุจุง ููุด ูุตููุน ุฎูุฏ ุตุญุจุช ฺฉูุฏ ู ุนููฺฉุฑุฏ ุขู ุฑุง ุจุฑ ุงุณุงุณ ุฏุณุชูุฑุงูุนููโูุง ุณุงุฏุจุงุฑ ุจุณูุฌุฏ.")

# ุงฺฏุฑ ฺฉูุฏ API ูุงุฑุฏ ูุดุฏู ุจูุฏุ ูพุงู ุฑุงูููุง ููุงุด ุจุฏู
if not api_key:
    st.info("ูุทูุงู ุจุฑุง ุดุฑูุนุ ฺฉูุฏ API Gemini ุฎูุฏ ุฑุง ุฏุฑ ุณุงุฏุจุงุฑ ูุงุฑุฏ ฺฉูุฏ.")
    st.stop()


# ููุฏุงุฑุฏู ุงููู ุชุงุฑุฎฺู ฺุช ุฏุฑ session_state
if "messages" not in st.session_state:
    st.session_state.messages = []

# ููุงุด ูพุงูโูุง ูุจู
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ุฏุฑุงูุช ูุฑูุฏ ุงุฒ ฺฉุงุฑุจุฑ
if user_prompt := st.chat_input("ุดูุง (ุฏุฑ ููุด ูุดุชุฑ):"):
    # ุงุถุงูู ฺฉุฑุฏู ูพุงู ฺฉุงุฑุจุฑ ุจู ุชุงุฑุฎฺู ู ููุงุด ุขู
    st.session_state.messages.append({"role": "user", "content": user_prompt})
    with st.chat_message("user"):
        st.markdown(user_prompt)

    # ุณุงุฎุช ูุฏู ุจุง ูพุฑุงููพุช ุณุณุชู
    model = genai.GenerativeModel(
        model_name='gemini-1.5-flash-latest',
        system_instruction=system_prompt
    )

    # ุณุงุฎุช ุชุงุฑุฎฺู ุจุฑุง ุงุฑุณุงู ุจู API (ุจุฏูู ูพุฑุงููพุช ุณุณุชู)
    chat_history_for_api = [{"role": msg["role"], "parts": [msg["content"]]} for msg in st.session_state.messages]
    
    # ููุงุด ุญุงูุช ููุฏูฺฏ ู ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู Gemini
    with st.spinner("ููุด ูุตููุน ุฏุฑ ุญุงู ูฺฉุฑ ฺฉุฑุฏู ุงุณุช..."):
        try:
            response = model.generate_content(chat_history_for_api)
            ai_response = response.text
            
            # ุงุถุงูู ฺฉุฑุฏู ูพุงุณุฎ ุฑุจุงุช ุจู ุชุงุฑุฎฺู ู ููุงุด ุขู
            st.session_state.messages.append({"role": "assistant", "content": ai_response})
            with st.chat_message("assistant"):
                st.markdown(ai_response)

        except Exception as e:

            st.error(f"ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง Gemini ุฑุฎ ุฏุงุฏ: {e}")
