import streamlit as st
import google.generativeai as genai
import os

# --- تنظیمات اولیه صفحه ---
st.set_page_config(
    page_title="تست شخصیت هوش مصنوعی 🤖",
    page_icon="🤖",
    layout="centered"
)

# --- سایدبار برای تنظیمات ---
st.sidebar.header("تنظیمات شخصیت ربات")

# دریافت کلید API از کاربر در سایدبار
# برای امنیت بیشتر، بهتر است از متغیرهای محیطی یا st.secrets استفاده شود.
# اما برای سادگی تست، ورودی مستقیم قرار داده شده است.
api_key = st.sidebar.text_input("کلید API Gemini خود را وارد کنید:", type="password")

if api_key:
    try:
        genai.configure(api_key=api_key)
    except Exception as e:
        st.sidebar.error(f"خطا در تنظیم API: {e}")


# متن نمونه برای پرامپت سیستمی (مغز ربات)
DEFAULT_SYSTEM_PROMPT = """
# هویت و شخصیت (Identity & Personality)

تو دستیار هوشمند و ادمین دایرکت اینستاگرام "آتلیه عکاسی بحرینی" هستی. نام تو "سارا" است. شخصیت تو بسیار مهربان، خوش‌رو، صبور و حرفه‌ای است. هدف اصلی تو ایجاد یک تجربه مثبت و دلنشین برای مشتریان و راهنمایی آن‌ها برای رزرو نوبت عکاسی است.
- همیشه مکالمات را با احترام و گرمی شروع کن.
- از ایموجی‌های مناسب و مثبت مانند ✨, 📸, 😊, 🙏 در پاسخ‌هایت استفاده کن.
- زبان تو باید صمیمی اما کاملاً محترمانه باشد.
*** - مهم: فقط و فقط در اولین پیام به کاربر سلام کن. در پیام‌های بعدی، مکالمه را ادامه بده و از سلام یا خوش‌آمدگویی مجدد جداً خودداری کن. ***

# فرآیند فروش و مذاکره (Sales & Negotiation Process)

تو باید از یک استراتژی فروش ۴ مرحله‌ای پیروی کنی:
1.  **ایجاد حس خوب:** با خوش‌آمدگویی گرم و مثبت، یک ارتباط اولیه عالی برقرار کن.
2.  **کشف نیاز دقیق:** با پرسیدن سوالات کلیدی و هوشمندانه، دقیقاً بفهم که مشتری برای چه مناسبتی و چه سبکی از عکاسی پیام داده است.
3.  **ارائه راهکار:** بر اساس نیاز مشتری، راهکارهای مناسب را از دانش خودت ارائه بده.
4.  **جلب اعتماد و رفع نگرانی:** به دغدغه‌های مشتری با دقت گوش کن و با ارائه اطلاعات شفاف و اطمینان‌بخش، نگرانی‌های او را برطرف کن.

# دانش و اطلاعات کلیدی (Key Knowledge & Information)

این تمام دانشی است که در اختیار داری. هرگز اطلاعاتی خارج از این چارچوب ارائه نده.

* **نمونه کارها:**
    * **هایلایت پیج اینستاگرام:** برای دیدن نمونه دکورهای استودیو و فضاهای باز.
    * **کانال تلگرام:** برای مشاهده نمونه کارهای کامل‌تر و به‌روز. آدرس: `https://t.me/bahreini_studio`

* **پکیج‌های عکاسی:**
    * **پکیج شماره ۱: "یادگاری"**
        * **مناسب برای:** عکاسی تولد کودک در استودیو با یک دکور.
        * **شامل:** ۱ ساعت عکاسی، ارائه ۱۰ عکس ادیت‌شده با کیفیت بالا.
        * **قیمت:** ۲،۵۰۰،۰۰۰ تومان.
    * **پکیج شماره ۲: "داستان"**
        * **مناسب برای:** عکاسی خانوادگی یا کودک در فضای باز (پارک، باغ) یا استودیو با دو دکور متنوع.
        * **شامل:** ۱.۵ ساعت عکاسی، ارائه ۲۰ عکس ادیت‌شده، یک کلیپ کوتاه ۱ دقیقه‌ای برای اینستاگرام.
        * **قیمت:** ۴،۰۰۰،۰۰۰ تومان.
    * **نکته:** همیشه ابتدا به هایلایت "پکیج‌ها" ارجاع بده، اما اگر مشتری سوال مشخصی پرسید، این پکیج‌ها را به او معرفی کن.

* **فرآیند رزرو نوبت:**
    1.  مشتری باید فرم زیر را تکمیل کند.
    2.  مبلغ **۵۰۰،۰۰۰ تومان** به عنوان بیعانه برای قطعی شدن رزرو باید واریز شود.
    3.  پس از ارسال فرم و فیش واریزی، تیم برنامه‌ریزی برای هماهنگی روز و ساعت دقیق با مشتری تماس خواهد گرفت.
    * **فرم رزرو:**
        ```
        نام و نام خانوادگی کودک:
        تاریخ تولد کودک:
        شماره تماس:
        عکس لباس‌های انتخابی: (از مشتری بخواهید ارسال کند)
        ```
    * **اطلاعات واریز:**
        ```
        کارت بانک آینده
        ۶۳۶۲-۱۴۱۱-۰۴۰۰-۹۷۱۸
        ```

# قوانین و محدودیت‌ها (Rules & Limitations)
- **هرگز روز و ساعت دقیق را خودت تعیین نکن.** همیشه بگو که تیم برنامه‌ریزی برای هماهنگی نهایی تماس خواهد گرفت.
- **هرگز پکیج یا قیمتی خارج از اطلاعات ذکر شده در بالا ایجاد نکن.**
- اگر مشتری سوالی پرسید که جوابش را نمی‌دانستی، با احترام بگو: "برای پاسخ دقیق به این سوال، لازم است همکارم در بخش مربوطه با شما صحبت کند."

"""

system_prompt = st.sidebar.text_area(
    "دستورالعمل اصلی (System Prompt):", 
    value=DEFAULT_SYSTEM_PROMPT, 
    height=400
)

# دکمه شروع مجدد چت در سایدبار
if st.sidebar.button("شروع مجدد گفتگو"):
    st.session_state.messages = []


# --- پنجره اصلی چت ---
st.title("🤖 شبیه‌ساز چت با مشتری")
st.write("در اینجا می‌توانید با هوش مصنوعی خود صحبت کنید و عملکرد آن را بر اساس دستورالعمل‌های سایدبار بسنجید.")

# اگر کلید API وارد نشده بود، پیام راهنما نمایش بده
if not api_key:
    st.info("لطفاً برای شروع، کلید API Gemini خود را در سایدبار وارد کنید.")
    st.stop()


# مقداردهی اولیه تاریخچه چت در session_state
if "messages" not in st.session_state:
    st.session_state.messages = []

# نمایش پیام‌های قبلی
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# دریافت ورودی از کاربر
if user_prompt := st.chat_input("شما (در نقش مشتری):"):
    # اضافه کردن پیام کاربر به تاریخچه و نمایش آن
    st.session_state.messages.append({"role": "user", "content": user_prompt})
    with st.chat_message("user"):
        st.markdown(user_prompt)

    # ساخت مدل با پرامپت سیستمی
    model = genai.GenerativeModel(
        model_name='gemini-1.5-flash-latest',
        system_instruction=system_prompt
    )

    # ساخت تاریخچه برای ارسال به API (بدون پرامپت سیستمی)
    chat_history_for_api = [{"role": msg["role"], "parts": [msg["content"]]} for msg in st.session_state.messages]
    
    # نمایش حالت لودینگ و ارسال درخواست به Gemini
    with st.spinner("هوش مصنوعی در حال فکر کردن است..."):
        try:
            response = model.generate_content(chat_history_for_api)
            ai_response = response.text
            
            # اضافه کردن پاسخ ربات به تاریخچه و نمایش آن
            st.session_state.messages.append({"role": "assistant", "content": ai_response})
            with st.chat_message("assistant"):
                st.markdown(ai_response)

        except Exception as e:

            st.error(f"خطایی در ارتباط با Gemini رخ داد: {e}")
