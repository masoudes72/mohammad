import streamlit as st
import google.generativeai as genai
import os

# --- ุชูุธูุงุช ุงููู ุตูุญู ---
st.set_page_config(
    page_title="ุชุณุช ุดุฎุตุช ููุด ูุตููุน ๐ค",
    page_icon="๐ค",
    layout="centered"
)

# --- ุณุงุฏุจุงุฑ ุจุฑุง ุชูุธูุงุช ---
st.sidebar.header("ุชูุธูุงุช ุดุฎุตุช ุฑุจุงุช")

# ุฏุฑุงูุช ฺฉูุฏ API ุงุฒ ฺฉุงุฑุจุฑ ุฏุฑ ุณุงุฏุจุงุฑ
# ุจุฑุง ุงููุช ุจุดุชุฑุ ุจูุชุฑ ุงุณุช ุงุฒ ูุชุบุฑูุง ูุญุท ุง st.secrets ุงุณุชูุงุฏู ุดูุฏ.
# ุงูุง ุจุฑุง ุณุงุฏฺฏ ุชุณุชุ ูุฑูุฏ ูุณุชูู ูุฑุงุฑ ุฏุงุฏู ุดุฏู ุงุณุช.
api_key = st.sidebar.text_input("ฺฉูุฏ API Gemini ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ:", type="password")

if api_key:
    try:
        genai.configure(api_key=api_key)
    except Exception as e:
        st.sidebar.error(f"ุฎุทุง ุฏุฑ ุชูุธู API: {e}")


# ูุชู ููููู ุจุฑุง ูพุฑุงููพุช ุณุณุชู (ูุบุฒ ุฑุจุงุช)
DEFAULT_SYSTEM_PROMPT = """
ุชู ูุฏุฑ ู ูพุงุณุฎฺฏู ูุดุชุฑุงู ุฏุฑ ุฏุงุฑฺฉุช ุงูุณุชุงฺฏุฑุงู ฺฉ ุขุชูู ูุจุงุณ ุฒูุงูู ุจู ูุงู 'ุขุชูู ุฑุฒ' ูุณุช. 
ุดุฎุตุช ุชู ุจุณุงุฑ ุฏูุณุชุงููุ ุตุจูุฑ ู ุดฺฉ ุงุณุช. ููุดู ุงุฒ ุงููุฌโูุง ููุงุณุจ ูุงููุฏ โจ ู ๐ ุงุณุชูุงุฏู ฺฉู.
ุชูุงู ุฏุงูุด ุชู ุฏุฑุจุงุฑู ูุญุตููุงุช ู ููุงูู ุฏุฑ ุงุฏุงูู ุขูุฏู ุงุณุช:

--- ูุณุช ูุญุตููุงุช ---
- ูุงูุชู ูุฏู ุจูุงุฑ: ุฌูุณ ฺฉุฑูพุ ููุช ฑุตฐฐุฐฐฐ ุชููุงูุ ุฑูฺฏโูุง: ูุดฺฉุ ฺฉุฑู. ุณุงุฒุจูุฏ: ณถ ุชุง ดด.
- ุดููุฒ ูุฏู ูุณุชุฑู: ุฌูุณ ุญุฑุฑุ ููุช ธฐฐุฐฐฐ ุชููุงูุ ุฑูฺฏโูุง: ุณูุฏุ ุตูุฑุช. ุณุงุฒุจูุฏ: ูุฑ ุณุงุฒ.

--- ุณูุงูุงุช ูุชุฏุงูู ---
- ุงุฑุณุงู: ุงุฑุณุงู ุจู ุชูุฑุงู ฑ ุฑูุฒู ุจุง ูพฺฉุ ุจู ุดูุฑุณุชุงูโูุง ณ ุฑูุฒู ุจุง ูพุณุช ูพุดุชุงุฒ. ูุฒูู ุงุฑุณุงู ณต ูุฒุงุฑ ุชููุงู.
- ุชุนูุถ: ุชุง ฒด ุณุงุนุช ูพุณ ุงุฒ ุชุญููุ ุฏุฑ ุตูุฑุช ุนุฏู ุงุณุชูุงุฏูุ ุงูฺฉุงู ุชุนูุถ ุณุงุฒ ูุฌูุฏ ุฏุงุฑุฏ.

--- ูุธูู ุชู ---
ุญุงูุง ุจุง ุงุณุชูุงุฏู ุฏูู ุงุฒ ุงู ุงุทูุงุนุงุช ู ุญูุธ ุดุฎุตุช ุจุฑูุฏุ ุจู ูพุงูโูุง ูุดุชุฑุงู ูพุงุณุฎ ุจุฏู.
ูุฑฺฏุฒ ุงุทูุงุนุงุช ุฎุงุฑุฌ ุงุฒ ุงู ฺุงุฑฺูุจ ุงุฑุงุฆู ูุฏู.
"""

system_prompt = st.sidebar.text_area(
    "ุฏุณุชูุฑุงูุนูู ุงุตู (System Prompt):", 
    value=DEFAULT_SYSTEM_PROMPT, 
    height=400
)

# ุฏฺฉูู ุดุฑูุน ูุฌุฏุฏ ฺุช ุฏุฑ ุณุงุฏุจุงุฑ
if st.sidebar.button("ุดุฑูุน ูุฌุฏุฏ ฺฏูุชฺฏู"):
    st.session_state.messages = []


# --- ูพูุฌุฑู ุงุตู ฺุช ---
st.title("๐ค ุดุจูโุณุงุฒ ฺุช ุจุง ูุดุชุฑ")
st.write("ุฏุฑ ุงูุฌุง ูโุชูุงูุฏ ุจุง ููุด ูุตููุน ุฎูุฏ ุตุญุจุช ฺฉูุฏ ู ุนููฺฉุฑุฏ ุขู ุฑุง ุจุฑ ุงุณุงุณ ุฏุณุชูุฑุงูุนููโูุง ุณุงุฏุจุงุฑ ุจุณูุฌุฏ.")

# ุงฺฏุฑ ฺฉูุฏ API ูุงุฑุฏ ูุดุฏู ุจูุฏุ ูพุงู ุฑุงูููุง ููุงุด ุจุฏู
if not api_key:
    st.info("ูุทูุงู ุจุฑุง ุดุฑูุนุ ฺฉูุฏ API Gemini ุฎูุฏ ุฑุง ุฏุฑ ุณุงุฏุจุงุฑ ูุงุฑุฏ ฺฉูุฏ.")
    st.stop()


# ููุฏุงุฑุฏู ุงููู ุชุงุฑุฎฺู ฺุช ุฏุฑ session_state
if "messages" not in st.session_state:
    st.session_state.messages = []

# ููุงุด ูพุงูโูุง ูุจู
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ุฏุฑุงูุช ูุฑูุฏ ุงุฒ ฺฉุงุฑุจุฑ
if user_prompt := st.chat_input("ุดูุง (ุฏุฑ ููุด ูุดุชุฑ):"):
    # ุงุถุงูู ฺฉุฑุฏู ูพุงู ฺฉุงุฑุจุฑ ุจู ุชุงุฑุฎฺู ู ููุงุด ุขู
    st.session_state.messages.append({"role": "user", "content": user_prompt})
    with st.chat_message("user"):
        st.markdown(user_prompt)

    # ุณุงุฎุช ูุฏู ุจุง ูพุฑุงููพุช ุณุณุชู
    model = genai.GenerativeModel(
        model_name='gemini-1.5-flash-latest',
        system_instruction=system_prompt
    )

    # ุณุงุฎุช ุชุงุฑุฎฺู ุจุฑุง ุงุฑุณุงู ุจู API (ุจุฏูู ูพุฑุงููพุช ุณุณุชู)
    chat_history_for_api = [{"role": msg["role"], "parts": [msg["content"]]} for msg in st.session_state.messages]
    
    # ููุงุด ุญุงูุช ููุฏูฺฏ ู ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู Gemini
    with st.spinner("ููุด ูุตููุน ุฏุฑ ุญุงู ูฺฉุฑ ฺฉุฑุฏู ุงุณุช..."):
        try:
            response = model.generate_content(chat_history_for_api)
            ai_response = response.text
            
            # ุงุถุงูู ฺฉุฑุฏู ูพุงุณุฎ ุฑุจุงุช ุจู ุชุงุฑุฎฺู ู ููุงุด ุขู
            st.session_state.messages.append({"role": "assistant", "content": ai_response})
            with st.chat_message("assistant"):
                st.markdown(ai_response)

        except Exception as e:
            st.error(f"ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง Gemini ุฑุฎ ุฏุงุฏ: {e}")